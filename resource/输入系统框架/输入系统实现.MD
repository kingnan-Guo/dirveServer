2025/04/20 00:10
# 名称
    分支
        dirver_raspberry_input_device_system_v0.2.3

    文件
        ./modules/app_input_device_system/app_input_device_system.c
        ./dirverModules/input_device_system/input_device_system.c

# 定义


# 流程


# 执行顺序


# 内部机制


# Makefile
# # XXXX ---------------------
input_device_system-y := $(MODULES_DIR)/input_device_system/input_device_system.o
obj-m := input_device_system.o


# 执行命令


insmod
rmmod

chmod +x main

ps -ef | grep main
kill -9 PID

ls /proc/device-tree/
ls /sys/devices/platform/
dmesg | tail
cat /proc/devices  
cd /sys/class 





make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- dtbs -j$(nproc) 


# 扩展


    修改
        sources/linux-rpi-6.6.y/arch/arm/boot/dts/broadcom/bcm2710-rpi-3-b-plus.dts

   在  
    /opt/sources/linux-rpi-6.6.y/scripts/dtc/include-prefixes/arm/broadcom/bcm2710-rpi-3-b-plus.dts



    make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-  dtbs  V=1 



    编译结果
    arch/arm64/boot/dts/broadcom/bcm2710-rpi-3-b-plus.dtb

    替换  
    /boot/firmware 下的 设备树



    ls /proc/device-tree/

    ls /proc/device-tree/gpio-keys

    ls /proc/device-tree/input_device/
    '#address-cells'   button@0   button@1   compatible   name  '#size-cells'


    sudo insmod input_device.ko 

    后 

    cat /proc/bus/input/devices
    打印出

    I: Bus=0019 Vendor=0001 Product=0001 Version=0100
    N: Name="input_device"
    P: Phys=input_device
    S: Sysfs=/devices/platform/input_device/input/input8
    U: Uniq=
    H: Handlers=kbd event7 
    B: PROP=0
    B: EV=3


    hexdump /dev/input/event7 -o -v -e '16/1 "%02x " "\n"'



    ps -ef | grep hexdump





dmesg | grep input_device
sudo evtest /dev/input/eventX







GPIO 25 高电平  打印
0000000  161575  064003  000000  000000  100307  000007  000000  000000
7d e3 03 68 00 00 00 00 c7 80 07 00 00 00 00 00
0000010  000001  000162  000000  000000  161575  064003  000000  000000
01 00 72 00 00 00 00 00 7d e3 03 68 00 00 00 00
0000020  100307  000007  000000  000000  000000  000000  000000  000000
c7 80 07 00 00 00 00 00 00 00 00 00 00 00 00 00


GPIO 25 低电平    打印

0000030  161614  064003  000000  000000  043010  000004  000000  000000
8c e3 03 68 00 00 00 00 08 46 04 00 00 00 00 00
0000040  000001  000162  000001  000000  161614  064003  000000  000000
01 00 72 00 01 00 00 00 8c e3 03 68 00 00 00 00
0000050  043010  000004  000000  000000  000000  000000  000000  000000
08 46 04 00 00 00 00 00 00 00 00 00 00 00 00 00



输入事件格式
每个输入事件是 16 字节的 struct input_event（32 位系统），定义如下

struct input_event {
    struct timeval time; /* 8 bytes: seconds (4) + microseconds (4) */
    __u16 type;          /* 2 bytes: 事件类型 (EV_KEY, EV_SYN) */
    __u16 code;          /* 2 bytes: 按键码 (KEY_BACK) */
    __s32 value;         /* 4 bytes: 事件值 (0 或 1) */
};


time：事件时间戳（秒 + 微秒）。
type：事件类型（EV_KEY=0x01, EV_SYN=0x00）。
code：按键码（例如 KEY_BACK=114）。
value：事件值（1=按下，0=释放）。





01 00 72 00 00 00 00 00 7d e3 03 68 00 00 00 00
时间戳：7d e3 03 68 00 00 00 00（同上）。
type：01 00 = 0x0001 = EV_KEY（按键事件）。
code：72 00 = 0x0072 = 114 = KEY_BACK。
与设备树匹配：button@2 的 linux,code = <114>。
value：00 00 00 00 = 0（按键释放）。
含义：
按键 KEY_BACK（114）被释放（value=0）。
表示 GPIO25 为高电平（非激活状态，gpios = <&gpio 25 1> 为低电平有效）。



01 00 72 00 01 00 00 00 8c e3 03 68 00 00 00 00
时间戳：8c e3 03 68 00 00 00 00。
type：01 00 = 0x0001 = EV_KEY。
code：72 00 = 0x0072 = 114 = KEY_BACK。
value：01 00 00 00 = 1（按键按下）。
含义：
按键 KEY_BACK（114）被按下（value=1）。
表示 GPIO25 低电平（0V），激活（active-low），符合预期。







GPIO 25 低电平    打印
0000000  163550  064003  000000  000000  070434  000016  000000  000000
68 e7 03 68 00 00 00 00 1c 71 0e 00 00 00 00 00
0000010  000001  000162  000001  000000  163550  064003  000000  000000
01 00 72 00 01 00 00 00 68 e7 03 68 00 00 00 00
0000020  070434  000016  000000  000000  000000  000000  000000  000000
1c 71 0e 00 00 00 00 00 00 00 00 00 00 00 00 00




GPIO 25 高电平    打印
0000030  163601  064003  000000  000000  131277  000012  000000  000000
81 e7 03 68 00 00 00 00 bf b2 0a 00 00 00 00 00
0000040  000001  000162  000000  000000  163601  064003  000000  000000
01 00 72 00 00 00 00 00 81 e7 03 68 00 00 00 00
0000050  131277  000012  000000  000000  000000  000000  000000  000000
bf b2 0a 00 00 00 00 00 00 00 00 00 00 00 00 00




运行 app


./main /dev/input/event7