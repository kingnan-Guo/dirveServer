2025/05/27 00:10
# 层级中断
    分支
        dirver_raspberry_XXXXX_vX.X.X

    文件
        ./dirverModules/interrupt_system_level/virtual_interrupt_system.c
        ./modules/interrupt_system/gpio_key_drv.c


# 定义
分为上下两个层级的中断控制器 
每一个 gpio 对应一个中断 控制器
gpio0 触发 的就是 100 号 中断
gpio1 触发 101 号中断

是 1 对  1 的关系，无需 分辨是谁发生的中断

通过 gpio0 -> heardware_irq (100) -> irq_desc(第n个，储存在 irq_domain里)-　>找到里面的  handleA 进行执行

在执行 hadleA 的时候 
handleA ：{
    mask/ack： 在屏蔽的时候要屏蔽多层的中断控制器，所以 进行 递归调用 不断找到上一层的 中断控制器，屏蔽掉（irq_data，irq_chipB中包含上一层级的 mask unmask）
    处理
    unmask



}


# 流程

1 DTS 里面包含那个中断：gpio heardware_irq
2 内核处理 DTS ：
    a gpio domain ，使用translate 来解析设备树， 解析设备树 后知道 那使用哪一个硬件中断
    b 内核会分配 irq_desc ，序号是 virtual_irq number
    c heardware_irq 和  virtual_irq 保存到 irq_domain 中
    d gpio domain ops 调用 alloc 进一步处理
        1 alloc 函数 为irq_desc 提供irq_dataB：（irq_chiB 使用里面的屏蔽函数 屏蔽中断）
        2 调用parent 父级里的 Domain 的alloc ，也就是gic 的allc 函数 通古偶 gpio_irq 找到 GIC_irq  ，把GIC_irq 和 virtual_irq 保存到 gic_domain 中，， 设置 irq_desc[] 的handlA 函数，来自于 GIC

# 执行顺序


# 内部机制


# Makefile
# # interrupt_system    子系统  层级---------------------
virtual_interrupt_system-y := $(MODULES_DIR)/interrupt_system_level/virtual_interrupt_system.o
obj-m += virtual_interrupt_system.o
gpio_key_drv-y := $(MODULES_DIR)/interrupt_system/gpio_key_drv.o
obj-m += gpio_key_drv.o


# 执行命令


insmod
rmmod

chmod +x main

ps -ef | grep main
kill -9 PID

ls /proc/device-tree/
ls /sys/devices/platform/
dmesg | tail
cat /proc/devices  
cd /sys/class 



# 扩展



设备树
/{

    virtual_interrupt_controller: virtual_interrupt_controller {
        compatible = "kingnan,virtual_interrupt_controller";
        interrupt-controller;
        #interrupt-cells = <2>;
        interrupt-parent = <&intc>;/** 指定中断控制器 , 向 这个中断控制器 发送 n 号 中断 */
        interrupts = <0 0>;
       upper_hwirq_base = <100>;/** 中断号偏移 */
    }


 


    /** 按键程序设备树 */
    gpio_keys: gpio_keys {
        compatible = "kingnan,gpio-keys";
        interrupt-parent = <&virtual_irq_controller>;/** 指定中断控制器 */
        interrupts = <0 1>, <1 1>;/** 使用 虚拟中控制器中的  0号中断   上升沿触发 */
    }


}